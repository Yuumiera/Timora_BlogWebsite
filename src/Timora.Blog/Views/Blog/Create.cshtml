@using System.Linq
@using Microsoft.AspNetCore.Localization
@using Timora.Blog.Models.ViewModels
@model Timora.Blog.Models.ViewModels.PostCreateViewModel
@{
    ViewData["Title"] = "Yeni YazÄ±";
    var categories = ViewBag.Categories as IEnumerable<Timora.Blog.Models.Category> ?? Enumerable.Empty<Timora.Blog.Models.Category>();
    
    // Get current culture
    var requestCultureFeature = Context.Features.Get<IRequestCultureFeature>();
    var currentCulture = requestCultureFeature?.RequestCulture?.UICulture?.Name ?? "tr-TR";
    if (string.IsNullOrEmpty(currentCulture) || currentCulture == "tr") currentCulture = "tr-TR";
    var L = new Func<string, string>((key) => LanguageStrings.Get(key, currentCulture));
}

<div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-transparent border-0 pb-0 pt-4 px-4">
                <h1 class="h3 mb-0 text-success-emphasis">Yeni Blog YazÄ±sÄ±</h1>
                <p class="text-muted small mb-0 mt-2">Hikayeni paylaÅŸ, ilham ver, dÃ¼nyayÄ± keÅŸfet!</p>
            </div>
            <div class="card-body p-4 p-lg-5">
                <form asp-action="Create" asp-controller="Blog" method="post" enctype="multipart/form-data" id="postForm">
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                    <!-- BaÅŸlÄ±k -->
                    <div class="mb-4">
                        <label asp-for="Title" class="form-label fw-semibold">
                            BaÅŸlÄ±k <span class="text-danger">*</span>
                        </label>
                        <input asp-for="Title" 
                               class="form-control form-control-lg" 
                               placeholder="YazÄ±nÄ±n baÅŸlÄ±ÄŸÄ±nÄ± girin..."
                               maxlength="200"
                               id="titleInput" />
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span asp-validation-for="Title" class="text-danger"></span>
                            <small class="text-muted">
                                <span id="titleCharCount">0</span>/200 karakter
                            </small>
                        </div>
                        <div class="form-text">Dikkat Ã§ekici ve aÃ§Ä±klayÄ±cÄ± bir baÅŸlÄ±k seÃ§in</div>
                    </div>

                    <!-- Kategori -->
                    <div class="mb-4">
                        <label asp-for="CategoryId" class="form-label fw-semibold">
                            Kategori <span class="text-danger">*</span>
                        </label>
                        @if (categories.Any())
                        {
                            <select asp-for="CategoryId" class="form-select form-select-lg">
                                <option value="">Kategori seÃ§iniz...</option>
                                @foreach (var c in categories)
                                {
                                    var categoryName = L(c.Slug);
                                    <option value="@c.Id">@categoryName</option>
                                }
                            </select>
                            <span asp-validation-for="CategoryId" class="text-danger"></span>
                            <div class="form-text">YazÄ±nÄ±zÄ±n hangi kategoriye ait olduÄŸunu seÃ§in</div>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <strong>UyarÄ±:</strong> HenÃ¼z kategori eklenmemiÅŸ. LÃ¼tfen Ã¶nce kategori ekleyin.
                            </div>
                            <select asp-for="CategoryId" class="form-select form-select-lg" disabled>
                                <option value="">Kategori bulunamadÄ±</option>
                            </select>
                        }
                    </div>

                    <!-- Kapak FotoÄŸrafÄ± -->
                    <div class="mb-4">
                        <label asp-for="CoverImage" class="form-label fw-semibold">
                            Kapak FotoÄŸrafÄ± <span class="text-danger">*</span>
                        </label>
                        <div class="cover-image-upload-wrapper">
                            <input type="file" 
                                   asp-for="CoverImage" 
                                   class="form-control form-control-lg" 
                                   accept="image/*" 
                                   id="coverImageInput"
                                   required />
                            <div class="form-text mb-3">JPG, PNG veya GIF formatÄ±nda, maksimum 5MB</div>
                            
                            <!-- GÃ¶rsel Ã–nizleme -->
                            <div id="imagePreview" class="image-preview-container" style="display: none;">
                                <div class="image-preview-wrapper">
                                    <img id="previewImage" src="" alt="Ã–nizleme" class="preview-image" />
                                    <button type="button" class="btn-remove-image" id="removeImageBtn" aria-label="GÃ¶rseli kaldÄ±r">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                                <p class="text-muted small mt-2 mb-0">Kapak fotoÄŸrafÄ± Ã¶nizlemesi</p>
                            </div>
                        </div>
                        <span asp-validation-for="CoverImage" class="text-danger"></span>
                    </div>

                    <!-- Ä°Ã§erik -->
                    <div class="mb-4">
                        <label asp-for="Content" class="form-label fw-semibold">
                            Ä°Ã§erik <span class="text-danger">*</span>
                        </label>
                        <div id="editor-container" style="min-height: 400px; background-color: var(--card-bg); border: 1px solid var(--border-soft); border-radius: 0.375rem;"></div>
                        <textarea asp-for="Content" 
                                  id="contentInput" 
                                  style="display: none;"></textarea>
                        <span asp-validation-for="Content" class="text-danger"></span>
                        <div class="form-text mt-2">
                            Word benzeri bir editÃ¶r kullanarak yazÄ±nÄ±zÄ± formatlayabilirsiniz. KalÄ±n, italik, baÅŸlÄ±k, liste ve daha fazlasÄ±.
                        </div>
                    </div>

                    <!-- Form ButonlarÄ± -->
                    <div class="d-flex flex-column flex-sm-row gap-3 justify-content-end pt-3 border-top">
                        <a asp-controller="Blog" asp-action="Index" class="btn btn-outline-secondary">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                                <line x1="19" y1="12" x2="5" y2="12"></line>
                                <polyline points="12 19 5 12 12 5"></polyline>
                            </svg>
                            Ä°ptal
                        </a>
                        <button type="submit" class="btn btn-success btn-lg">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            YazÄ±yÄ± YayÄ±nla
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
    <!-- Quill.js Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Quill Editor Initialization
            const quill = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: {
                        container: [
                            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'align': [] }],
                            ['link', 'image', 'blockquote', 'code-block'],
                            ['emoji'],
                            ['clean']
                        ],
                        handlers: {
                            'emoji': function() {
                                showEmojiPicker(quill);
                            }
                        }
                    }
                },
                placeholder: 'YazÄ±nÄ±zÄ±n iÃ§eriÄŸini buraya yazÄ±n...'
            });

            // Emoji Picker Function
            function showEmojiPicker(editor) {
                // Remove existing picker if any
                const existingPicker = document.getElementById('emojiPickerModal');
                if (existingPicker) {
                    existingPicker.remove();
                }

                // Popular emojis
                const emojis = [
                    'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ',
                    'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™',
                    'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”',
                    'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥',
                    'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®',
                    'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜¶â€ğŸŒ«ï¸', 'ğŸ˜µ', 'ğŸ˜µâ€ğŸ’«', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜',
                    'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³',
                    'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–',
                    'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬',
                    'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸', 'ğŸ’‹', 'ğŸ’Œ', 'ğŸ’˜', 'ğŸ’', 'ğŸ’–', 'ğŸ’—',
                    'ğŸ’“', 'ğŸ’', 'ğŸ’•', 'ğŸ’Ÿ', 'â£ï¸', 'ğŸ’”', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š',
                    'ğŸ’™', 'ğŸ’œ', 'ğŸ¤', 'ğŸ–¤', 'ğŸ¤', 'ğŸ’¯', 'ğŸ’¢', 'ğŸ’¥', 'ğŸ’«', 'ğŸ’¦',
                    'ğŸ’¨', 'ğŸ•³ï¸', 'ğŸ’£', 'ğŸ’¬', 'ğŸ‘ï¸â€ğŸ—¨ï¸', 'ğŸ—¨ï¸', 'ğŸ—¯ï¸', 'ğŸ’­', 'ğŸ’¤', 'ğŸ‘‹',
                    'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ',
                    'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘',
                    'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™',
                    'âœï¸', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ',
                    'ğŸ«€', 'ğŸ«', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹', 'ğŸ©¸'
                ];

                // Create modal
                const modal = document.createElement('div');
                modal.id = 'emojiPickerModal';
                modal.className = 'emoji-picker-modal';
                modal.setAttribute('role', 'dialog');
                modal.setAttribute('aria-modal', 'true');
                modal.setAttribute('aria-label', 'Emoji SeÃ§ici');

                // Create modal content
                const modalContent = document.createElement('div');
                modalContent.className = 'emoji-picker-content';

                const modalHeader = document.createElement('div');
                modalHeader.className = 'emoji-picker-header';
                modalHeader.innerHTML = `
                    <h3>Emoji SeÃ§</h3>
                    <button type="button" class="emoji-picker-close" aria-label="Kapat">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                `;

                const emojiGrid = document.createElement('div');
                emojiGrid.className = 'emoji-picker-grid';
                emojis.forEach(emoji => {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.type = 'button';
                    emojiBtn.className = 'emoji-picker-item';
                    emojiBtn.textContent = emoji;
                    emojiBtn.setAttribute('aria-label', `Emoji ekle: ${emoji}`);
                    emojiBtn.addEventListener('click', function() {
                        const range = editor.getSelection(true);
                        editor.insertText(range.index, emoji);
                        editor.setSelection(range.index + emoji.length);
                        modal.remove();
                    });
                    emojiGrid.appendChild(emojiBtn);
                });

                modalContent.appendChild(modalHeader);
                modalContent.appendChild(emojiGrid);
                modal.appendChild(modalContent);

                // Close handlers
                const closeBtn = modalHeader.querySelector('.emoji-picker-close');
                closeBtn.addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') modal.remove();
                });

                document.body.appendChild(modal);
                closeBtn.focus();
            }

            // Sync Quill content to hidden textarea
            const contentInput = document.getElementById('contentInput');
            if (contentInput && quill) {
                // Set initial content if exists
                if (contentInput.value) {
                    quill.root.innerHTML = contentInput.value;
                }

                // Update textarea on content change
                quill.on('text-change', function() {
                    contentInput.value = quill.root.innerHTML;
                });

                // Also update on selection change (for better sync)
                quill.on('selection-change', function() {
                    contentInput.value = quill.root.innerHTML;
                });

                // Update before form submit
                const postForm = document.getElementById('postForm');
                if (postForm) {
                    postForm.addEventListener('submit', function() {
                        contentInput.value = quill.root.innerHTML;
                    });
                }
            }

            // BaÅŸlÄ±k karakter sayacÄ±
            const titleInput = document.getElementById('titleInput');
            const titleCharCount = document.getElementById('titleCharCount');
            
            if (titleInput && titleCharCount) {
                function updateCharCount() {
                    const length = titleInput.value.length;
                    titleCharCount.textContent = length;
                    if (length > 180) {
                        titleCharCount.classList.add('text-warning');
                        titleCharCount.classList.remove('text-danger');
                    } else if (length > 195) {
                        titleCharCount.classList.remove('text-warning');
                        titleCharCount.classList.add('text-danger');
                    } else {
                        titleCharCount.classList.remove('text-warning', 'text-danger');
                    }
                }
                
                titleInput.addEventListener('input', updateCharCount);
                updateCharCount(); // Ä°lk yÃ¼klemede de gÃ¼ncelle
            }

            // Kapak fotoÄŸrafÄ± Ã¶nizleme
            const coverImageInput = document.getElementById('coverImageInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            const removeImageBtn = document.getElementById('removeImageBtn');

            if (coverImageInput && imagePreview && previewImage && removeImageBtn) {
                coverImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Dosya boyutu kontrolÃ¼ (5MB)
                        const maxSize = 5 * 1024 * 1024; // 5MB in bytes
                        if (file.size > maxSize) {
                            showToast('Dosya Ã§ok bÃ¼yÃ¼k', 'Kapak fotoÄŸrafÄ± maksimum 5MB olabilir. LÃ¼tfen daha kÃ¼Ã§Ã¼k bir dosya seÃ§in.', 'error');
                            coverImageInput.value = '';
                            imagePreview.style.display = 'none';
                            return;
                        }

                        // Dosya tipi kontrolÃ¼
                        if (!file.type.startsWith('image/')) {
                            showToast('GeÃ§ersiz dosya tipi', 'LÃ¼tfen bir gÃ¶rsel dosyasÄ± seÃ§in (JPG, PNG, GIF).', 'error');
                            coverImageInput.value = '';
                            imagePreview.style.display = 'none';
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImage.src = e.target.result;
                            imagePreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        imagePreview.style.display = 'none';
                    }
                });

                removeImageBtn.addEventListener('click', function() {
                    coverImageInput.value = '';
                    imagePreview.style.display = 'none';
                    previewImage.src = '';
                });
            }

            // Form gÃ¶nderim validasyonu
            const postForm = document.getElementById('postForm');
            if (postForm) {
                postForm.addEventListener('submit', function(e) {
                    // Sync Quill content before validation
                    if (quill) {
                        contentInput.value = quill.root.innerHTML;
                    }

                    const title = titleInput?.value.trim();
                    const category = document.querySelector('[name="CategoryId"]')?.value;
                    const content = contentInput?.value.trim();
                    const coverImage = coverImageInput?.files[0];

                    let hasError = false;

                    if (!title || title.length === 0) {
                        hasError = true;
                    }

                    if (!category || category === '') {
                        hasError = true;
                    }

                    // Check if content is empty (only whitespace or empty HTML tags)
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content || '';
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';
                    if (!textContent.trim()) {
                        showToast('Eksik Bilgi', 'LÃ¼tfen yazÄ± iÃ§eriÄŸi girin.', 'warning');
                        hasError = true;
                    }

                    if (!coverImage) {
                        showToast('Eksik Bilgi', 'LÃ¼tfen kapak fotoÄŸrafÄ± seÃ§in.', 'warning');
                        hasError = true;
                    }

                    if (hasError) {
                        e.preventDefault();
                        return false;
                    }
                });
            }
        });
    </script>
}


