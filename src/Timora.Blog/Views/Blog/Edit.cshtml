@using System.Linq
@model Timora.Blog.Models.ViewModels.PostCreateViewModel
@{
    ViewData["Title"] = "Yazıyı Düzenle";
    var categories = ViewBag.Categories as IEnumerable<Timora.Blog.Models.Category> ?? Enumerable.Empty<Timora.Blog.Models.Category>();
    var postId = ViewBag.PostId as int?;
    var currentCoverImage = ViewBag.CurrentCoverImage as string;
}

<div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-transparent border-0 pb-0 pt-4 px-4">
                <h1 class="h3 mb-0 text-success-emphasis">Yazıyı Düzenle</h1>
                <p class="text-muted small mb-0 mt-2">Yazınızı güncelleyin ve düzenleyin.</p>
            </div>
            <div class="card-body p-4 p-lg-5">
                <form asp-action="Edit" asp-controller="Blog" asp-route-id="@postId" method="post" enctype="multipart/form-data" id="postForm">
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                    <!-- Başlık -->
                    <div class="mb-4">
                        <label asp-for="Title" class="form-label fw-semibold">
                            Başlık <span class="text-danger">*</span>
                        </label>
                        <input asp-for="Title" 
                               class="form-control form-control-lg" 
                               placeholder="Yazının başlığını girin..."
                               maxlength="200"
                               id="titleInput" />
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span asp-validation-for="Title" class="text-danger"></span>
                            <small class="text-muted">
                                <span id="titleCharCount">0</span>/200 karakter
                            </small>
                        </div>
                        <div class="form-text">Dikkat çekici ve açıklayıcı bir başlık seçin</div>
                    </div>

                    <!-- Kategori -->
                    <div class="mb-4">
                        <label asp-for="CategoryId" class="form-label fw-semibold">
                            Kategori <span class="text-danger">*</span>
                        </label>
                        @if (categories.Any())
                        {
                            <select asp-for="CategoryId" class="form-select form-select-lg">
                                <option value="">Kategori seçiniz...</option>
                                @foreach (var c in categories)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            </select>
                            <span asp-validation-for="CategoryId" class="text-danger"></span>
                            <div class="form-text">Yazınızın hangi kategoriye ait olduğunu seçin</div>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <strong>Uyarı:</strong> Henüz kategori eklenmemiş. Lütfen önce kategori ekleyin.
                            </div>
                            <select asp-for="CategoryId" class="form-select form-select-lg" disabled>
                                <option value="">Kategori bulunamadı</option>
                            </select>
                        }
                    </div>

                    <!-- Kapak Fotoğrafı -->
                    <div class="mb-4">
                        <label asp-for="CoverImage" class="form-label fw-semibold">
                            Kapak Fotoğrafı
                        </label>
                        <div class="cover-image-upload-wrapper">
                            <input type="file" 
                                   asp-for="CoverImage" 
                                   class="form-control form-control-lg" 
                                   accept="image/*" 
                                   id="coverImageInput" />
                            <div class="form-text mb-3">JPG, PNG veya GIF formatında, maksimum 5MB. Yeni fotoğraf seçmezseniz mevcut fotoğraf korunur.</div>
                            
                            <!-- Mevcut Görsel -->
                            @if (!string.IsNullOrWhiteSpace(currentCoverImage))
                            {
                                <div class="mb-3">
                                    <p class="small text-muted mb-2">Mevcut kapak fotoğrafı:</p>
                                    <div class="image-preview-wrapper" style="max-width: 300px;">
                                        <img src="@currentCoverImage" alt="Mevcut kapak fotoğrafı" class="preview-image" />
                                    </div>
                                </div>
                            }
                            
                            <!-- Yeni Görsel Önizleme -->
                            <div id="imagePreview" class="image-preview-container" style="display: none;">
                                <div class="image-preview-wrapper">
                                    <img id="previewImage" src="" alt="Önizleme" class="preview-image" />
                                    <button type="button" class="btn-remove-image" id="removeImageBtn" aria-label="Görseli kaldır">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                                <p class="text-muted small mt-2 mb-0">Yeni kapak fotoğrafı önizlemesi</p>
                            </div>
                        </div>
                        <span asp-validation-for="CoverImage" class="text-danger"></span>
                    </div>

                    <!-- İçerik -->
                    <div class="mb-4">
                        <label asp-for="Content" class="form-label fw-semibold">
                            İçerik <span class="text-danger">*</span>
                        </label>
                        <textarea asp-for="Content" 
                                  class="form-control" 
                                  rows="15" 
                                  placeholder="Yazınızın içeriğini buraya yazın..."
                                  id="contentInput"></textarea>
                        <span asp-validation-for="Content" class="text-danger"></span>
                        <div class="form-text">
                            HTML etiketleri kullanabilirsiniz. İçeriğinizi zenginleştirmek için formatlama kullanın.
                        </div>
                    </div>

                    <!-- Form Butonları -->
                    <div class="d-flex flex-column flex-sm-row gap-3 justify-content-between pt-3 border-top">
                        <a asp-controller="Blog" asp-action="Index" class="btn btn-outline-secondary">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                                <line x1="19" y1="12" x2="5" y2="12"></line>
                                <polyline points="12 19 5 12 12 5"></polyline>
                            </svg>
                            İptal
                        </a>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                    <polyline points="7 3 7 8 15 8"></polyline>
                                </svg>
                                Değişiklikleri Kaydet
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Başlık karakter sayacı
            const titleInput = document.getElementById('titleInput');
            const titleCharCount = document.getElementById('titleCharCount');
            
            if (titleInput && titleCharCount) {
                function updateCharCount() {
                    const length = titleInput.value.length;
                    titleCharCount.textContent = length;
                    if (length > 180) {
                        titleCharCount.classList.add('text-warning');
                        titleCharCount.classList.remove('text-danger');
                    } else if (length > 195) {
                        titleCharCount.classList.remove('text-warning');
                        titleCharCount.classList.add('text-danger');
                    } else {
                        titleCharCount.classList.remove('text-warning', 'text-danger');
                    }
                }
                
                titleInput.addEventListener('input', updateCharCount);
                updateCharCount();
            }

            // Kapak fotoğrafı önizleme
            const coverImageInput = document.getElementById('coverImageInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            const removeImageBtn = document.getElementById('removeImageBtn');

            if (coverImageInput && imagePreview && previewImage && removeImageBtn) {
                coverImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const maxSize = 5 * 1024 * 1024;
                        if (file.size > maxSize) {
                            showToast('Dosya çok büyük', 'Kapak fotoğrafı maksimum 5MB olabilir. Lütfen daha küçük bir dosya seçin.', 'error');
                            coverImageInput.value = '';
                            imagePreview.style.display = 'none';
                            return;
                        }

                        if (!file.type.startsWith('image/')) {
                            showToast('Geçersiz dosya tipi', 'Lütfen bir görsel dosyası seçin (JPG, PNG, GIF).', 'error');
                            coverImageInput.value = '';
                            imagePreview.style.display = 'none';
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImage.src = e.target.result;
                            imagePreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        imagePreview.style.display = 'none';
                    }
                });

                removeImageBtn.addEventListener('click', function() {
                    coverImageInput.value = '';
                    imagePreview.style.display = 'none';
                    previewImage.src = '';
                });
            }
        });
    </script>
}

